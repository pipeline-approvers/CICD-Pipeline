name: Azure-Board
on:
  push:
    tags:
      - 'release-v*.*'
jobs:
  create-task:
    runs-on: nu-laptop  # Assuming this is your Windows self-hosted runner
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Get Release Info
        uses: actions/github-script@v6
        id: release
        with:
          script: |
            const { owner, repo } = context.repo;
            const { data: releases } = await github.rest.repos.listReleases({
              owner,
              repo,
            });

            if (releases.length === 0) {
              throw new Error("No releases found.");
            }

            const latestRelease = releases[0];
            console.log(`Release: ${latestRelease.tag_name}, ${latestRelease.name}`);
            
            core.setOutput("tag_name", latestRelease.tag_name);
            core.setOutput("title", latestRelease.name);
            core.setOutput("body", latestRelease.body);

      - name: Create Azure Work Item
        shell: powershell
        run: |
          $headers = @{
              "Content-Type" = "application/json"
              "Authorization" = "Bearer ${{ secrets.AZURE_DEVOPS_TOKEN }}"
          }

          $body = @{
              "fields" = @{
                  "System.Title" = "Release: ${{ steps.release.outputs.title }}"
                  "System.Description" = "${{ steps.release.outputs.body }}"
              }
          } | ConvertTo-Json -Depth 3

          Invoke-WebRequest -Uri "https://dev.azure.com/Madhanum/Github-Notifications/_apis/wit/workitems/Task?api-version=6.0" `
              -Method Post `
              -Headers $headers `
              -Body $body
